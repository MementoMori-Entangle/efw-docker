/*
 * jQuery SatoshiMori Search Input Selector v1.2
 * http://dot-town-lab.com/laboratory/
 *
 * Copyright 2015 - .dotown-lab
 * Free to use and abuse under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 */
(function(e){var k=function(a,b,c){this.element=e(a);this.options=e.extend({},e.fn.smSearchInputSelector.defaults,b);this.id=c;this.dropdown=this.hidden=null;this.lists=[];this.pointer=[];this.hasTouch="ontouchstart"in window;this.is_focus=this.is_mouse=!1;this.lastkey=0;this.initial()};k.prototype={initial:function(){this.hidden=this.addhidden();this.setevent()},reset:function(a){this.element.val(a?a.name:"");this.hidden.val(a?a.value:"");this.dropdown.remove();this.dropdown=!1;this.lists=[];this.is_focus=this.is_mouse=!1;this.options.selected(a.value)},setevent:function(){this.element.on("mousedown",this.elementHandler());this.element.on("focus",this.elementHandler());this.element.on("keydown",this.searchHandler());this.element.on("keyup",this.searchHandler());this.hasTouch&&window.addEventListener("touchstart",this.cancelHandler(),!1);if(!this.hasTouch)try{window.addEventListener("mousedown",this.cancelHandler(),!1)}catch(a){document.attachEvent("onmousedown",this.cancelHandler())}},elementHandler:function(){var a=this;return function(b){switch(b.type){case "mousedown":a.is_mouse=!0;a.is_focus=!0;a.setPointer();a.dropdown=a.addDropdown();a.setDropdownStyle();break;case "focus":a.is_mouse||(a.is_focus=!0,a.setPointer(),a.dropdown=a.addDropdown(),a.setDropdownStyle())}}},selectHandler:function(a){var b=this;return function(c){c=a.data("num");b.reset(b.options.selector[c])}},searchHandler:function(){var a=this;return function(b){if(!a.dropdown)return 13==b.keyCode?!1:!0;if("keyup"==b.type){var c=a.getSearchSelector(e(this).val().trim());a.dropdown.find("ul").scrollTop(0);13==b.keyCode&&13==a.lastkey&&c&&a.reset(c)}if("keydown"==b.type&&(9==b.keyCode&&a.is_focus&&a.reset(a.getSearchSelector(e(this).val().trim())),a.lastkey=b.keyCode,13==b.keyCode))return!1}},cancelHandler:function(){var a=this;return function(b){if(!a.dropdown)return!1;var c=!1;b=b.target||b.srcElement;var d=null,f=0;if(!b)return!1;if(e(b).data("uniquename")==a.options.uniquename)c=(f=parseInt(e(b).data("sisid"),10))&&f!=a.id?!1:!0;else for(d=b.parentNode;d.tagName&&!c;)e(d).hasClass(a.options.classes.thisname)&&(c=(f=parseInt(e(d).data("sisid"),10))&&f!=a.id?!1:!0),d=d.parentNode;c||a.reset(a.getSearchSelector())}},addhidden:function(){var a=e(document.createElement("input"));a.addClass(this.options.classes.thisname+" "+this.options.classes.hidden);a.attr({type:"hidden",name:this.element.attr("name")});a.val(this.element.data("value"));this.element.attr("name","");this.element.data({sisid:this.id,uniquename:this.options.uniquename});this.element.after(a);return a},addDropdown:function(){var a=this;if(a.dropdown)return a.dropdown;var b=a.hidden.val(),c=e(document.createElement("div")),d="";c.attr("class",a.options.classes.thisname+" "+a.options.classes.dropdown);for(var f=0;f<a.options.selector.length;f++)var g=a.options.selector[f],d=d+("<li"+(b==g.value?' class="selected"':"")+' data-num="'+f+'">'+(g.name?g.name:"&nbsp;")+"</li>");c.html("<div><ul>"+d+"</ul></div>");c.find("ul").css("max-height",a.options["max-height"]);c.find("li").css("font-size",a.pointer.fs1);c.find("li").each(function(){var b=e(this);a.lists.push(b);b.on("click",a.selectHandler(b))});e("body").append(c);return c},setDropdownStyle:function(){if(!this.dropdown)return!1;"none"==this.dropdown.css("display")&&this.dropdown.css("display","block");var a=this.hidden.val(),b=e(document).height(),c=this.dropdown.height();this.dropdown.css({width:this.pointer.ow,top:c>b-(this.pointer.ot+this.pointer.oh)?this.pointer.ot-c:this.pointer.ot+this.pointer.oh,left:this.pointer.ol});if(a){for(var c=b=0,d=!0,f=0;f<this.lists.length;f++){var g=this.lists[f],h=g.data("num"),h=this.options.selector[h],g=g.outerHeight();h.value==a&&(d=!1);d&&(b+=g);c+=g}b=c-this.options["max-height"]>b?b:c-this.options["max-height"];this.dropdown.find("ul").scrollTop(b)}},setPointer:function(){var a=this.element.position(),b=this.element.offset(),c=parseInt(this.element.css("font-size"),10);return this.pointer={w:this.element.width(),h:this.element.height(),ow:this.element.outerWidth(),oh:this.element.outerHeight(),iw:this.element.innerWidth(),ih:this.element.innerHeight(),sh:0,soh:0,sih:0,t:a.top,l:a.left,ot:b.top,ol:b.left,fs1:c+this.options.addfontsize,fs2:12<=c?c-2:c}},getSearchSelector:function(a){var b=null;a=a?a:this.element.val().trim();a=this.getSearchStrings(a);for(var c=0;c<this.lists.length;c++){var d=this.lists[c],f=d.data("num"),f=this.options.selector[f],e=this.matchArray(a,f.search);d.css("display",e?"block":"none");e&&!b&&(b=f)}return b},getSearchStrings:function(a){if(!a)return!1;a=a.replace(/\s+/g," ");return a.split(" ")},matchArray:function(a,b){if(!a)return!0;for(var c=!0,d=0;d<a.length&&(c=b.match(new RegExp(a[d],"i"))?c:!1,c);d++);return c},inArray:function(a,b){if("object"!=typeof b||!b)return!1;for(var c=0;c<b.length;c++)if(b[c]===a)return!0;return!1}};e.fn.smSearchInputSelector=function(a){var b=1;return this.each(function(){new k(this,a,b);b++})};e.fn.smSearchInputSelector.defaults={uniquename:"jsSearchInputSelector",classes:{thisname:"jsSearchInputSelector",hidden:"hidden",dropdown:"dropdown"},selector:[],selected:function(a){return a},"max-height":250,addfontsize:0}})(jQuery);